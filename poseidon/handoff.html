<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.37">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Tuna Supply Chain Handoff</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="handoff_files/libs/clipboard/clipboard.min.js"></script>
<script src="handoff_files/libs/quarto-html/quarto.js"></script>
<script src="handoff_files/libs/quarto-html/popper.min.js"></script>
<script src="handoff_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="handoff_files/libs/quarto-html/anchor.min.js"></script>
<link href="handoff_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="handoff_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="handoff_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="handoff_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="handoff_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="handoff_files/libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<script src="handoff_files/libs/viz-1.8.2/viz.js"></script>
<link href="handoff_files/libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="handoff_files/libs/grViz-binding-1.0.9/grViz.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tuna Supply Chain Handoff</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="the-idea" class="level2">
<h2 class="anchored" data-anchor-id="the-idea">The idea</h2>
<p>The plan for the tuna supply chain piece was quite simple:</p>
<ol type="1">
<li>POSEIDON generates monthly landings per port</li>
<li>We find the optimal path for this raw fish to be processed and reach final markets</li>
<li>We back out from this the prices per kg per species in each port.</li>
</ol>
<p>The model was a simple linear program, which can be solved very quickly and wouldn’t slow down POSEIDON much.<br>
The model decision variables would all be in weight (of fish, of loins or of cans) and costs would be associated with edges (cost of transportation, processing, canning and tariffs). Even though we never got any data or functional form on the demand curve, we can still back out prices because of the presence of the WCPO suppliers. In short, as long as WCPO prices are in the model, ex-vessel prices at EPO ports emerge from the linear program as the value of not having to import one more kg of product from Thailand.</p>
</section>
<section id="deployment" class="level2">
<h2 class="anchored" data-anchor-id="deployment">Deployment</h2>
<p>The idea was to code this in python first during the development phase. This is purely because the tools for linear programming are a lot fancier there than in Java.<br>
My view was to first code it in <code>Pyomo</code>, which is a neat library for linear programming, then translate it into <code>google or</code> which is a library available both for python and java.<br>
As it stands now, only a prototype in <code>Pyomo</code> is available</p>
</section>
<section id="the-prototype" class="level2">
<h2 class="anchored" data-anchor-id="the-prototype">The Prototype</h2>
<p>I built a simple annual supply chain model for our first (and only) tuna supply chain slice.<br>
This we presented to the economic advisory group in FEB 2022.</p>
<p>The advisory group main comments were that:</p>
<ol type="1">
<li>It was incorrect to have WCPO selling loins with the EPO; WCPO should have been a player in the raw material section instead</li>
<li>It was unrealistic that Mexico would export canned tuna to Spain.</li>
<li>We needed better data on tariffs</li>
<li>We needed better data on local consumption</li>
</ol>
<p>As a consequence, in MAR-APR (before i had to switch to Tuna calibration) I primarilly focused on collecting data.<br>
A demo of some of the data-sets gathered is here:<br>
https://carrknight.github.io/poseidon/tuna_data_slice2.html</p>
</section>
<section id="prototypes-code" class="level2">
<h2 class="anchored" data-anchor-id="prototypes-code">Prototype’s code</h2>
<section id="variables" class="level3">
<h3 class="anchored" data-anchor-id="variables">Variables</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>DiagrammeR<span class="sc">::</span><span class="fu">grViz</span>(<span class="st">"digraph {</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="st">  graph [layout = dot, rankdir = TD]</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = rectangle style=filled fillcolor=cyan]        </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">  rec1 [label = 'Port'];</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">  rec2 [label = 'Processor'];</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">  rec3 [label =  'Canner'];</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = invhouse, fillcolor=pink]</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="st">    imp2 [label = 'WCPO Cans']</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">  imp1 [label = 'WCPO Loins']</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="st">  node [shape = ellipse fillcolor=green]</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="st">  dem4 [label = 'Loin Demand'];</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="st">  dem5 [label = 'Canned Demand'];</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="st">  # edge definitions with the node IDs</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="st">  rec1 -&gt; rec2 -&gt; rec3 </span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="st">  rec2 -&gt; dem4</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="st">    imp1 -&gt; rec3</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="st">  imp1 -&gt; dem4</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="st">    imp2 -&gt; dem5</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="st">    rec3 -&gt; dem5</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="st">  }"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="htmlwidget-b24a52ab2a16a1470d1b" style="width:100%;height:480px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-b24a52ab2a16a1470d1b">{"x":{"diagram":"digraph {\n  graph [layout = dot, rankdir = TD]\n  \n  node [shape = rectangle style=filled fillcolor=cyan]        \n  rec1 [label = \"Port\"];\n  rec2 [label = \"Processor\"];\n  rec3 [label =  \"Canner\"];\n  \n\n  node [shape = invhouse, fillcolor=pink]\n    imp2 [label = \"WCPO Cans\"]\n  imp1 [label = \"WCPO Loins\"]\n\n  node [shape = ellipse fillcolor=green]\n  dem4 [label = \"Loin Demand\"];\n  dem5 [label = \"Canned Demand\"];\n  \n  \n  # edge definitions with the node IDs\n  rec1 -> rec2 -> rec3 \n  rec2 -> dem4\n    imp1 -> rec3\n  imp1 -> dem4\n    imp2 -> dem5\n    rec3 -> dem5\n  }","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>Even though the program is written in python, it’s better to understand this as an AMPL problem. You write down the equations, set up the variables and the constraints and then let the linear optimizer solve this.<br>
You start by creating the model</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a Pyomo model object</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> pyomo.ConcreteModel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we need to start to input in the list of ports, canneries available, final market destinations, etc…</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">## where you get raw landings:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    model.PORTS <span class="op">=</span> pyomo.Set(initialize<span class="op">=</span>port_list)<span class="op">;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">## where you can can and/or loin</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    model.FACILITIES <span class="op">=</span> pyomo.Set(initialize<span class="op">=</span>cannery_list)<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">## where you sell your stuff</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    model.MARKETS <span class="op">=</span> pyomo.Set(initialize<span class="op">=</span>market_list)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where <code>port_list</code>, <code>cannery_list</code> and <code>market_list</code> are simple string lists.</p>
<p>Once that is done, we need to start defining variables to optimize. Imagine that there are only two ports: <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> and two canneries <span class="math inline">\(1\)</span> and <span class="math inline">\(2\)</span>. There are then four flows <span class="math inline">\(X\)</span> variables:</p>
<p><span class="math display">\[ X_{a,1} \quad X_{a,2} \quad X_{b,1} \quad X_{b,2}  \]</span></p>
<p>Which represent the flow of goods from port <span class="math inline">\(a\)</span> to cannery <span class="math inline">\(1\)</span>, from port <span class="math inline">\(a\)</span> to cannery <span class="math inline">\(2\)</span>, etc.</p>
<p>There are four echelons in this model: from port to processor (loiner), from loiner to cannery and then from cannery to final market. We need to however add the special case of loins and canned products being available from the WCPO (this is from the prototype where raw imports weren’t allowed):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># raw tuna ---&gt; cooked loins</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    model.port_to_processors <span class="op">=</span> pyomo.Var(PORTS, FACILITIES,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                                         domain<span class="op">=</span>pyomo.NonNegativeReals)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">## second rung of the supply chain is processors--to-canneries (output canned tuna)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">## cooked loins ---&gt; "canned" tuna</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    model.processor_to_cannery <span class="op">=</span> pyomo.Var(FACILITIES,FACILITIES,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                           domain<span class="op">=</span>pyomo.NonNegativeReals)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">## you can also export some of the loins out in the markets directly (i.e. loins from Ecuador to spain)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">## this at some point should be endogenous, but is exogenous now!</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    model.processors_to_export <span class="op">=</span> pyomo.Var(FACILITIES,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                                           MARKETS, domain<span class="op">=</span>pyomo.NonNegativeReals)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">## second run of the supply chain is canneries--to--markets</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    model.canneries_to_market <span class="op">=</span> pyomo.Var(FACILITIES, MARKETS,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                                          domain<span class="op">=</span>pyomo.NonNegativeReals)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">## you can import loins from WCPO.... (WCPO--&gt;cannery1, WCPO---&gt;cannery2, ...)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    model.loins_imports_as_intermediate_product <span class="op">=</span> pyomo.Var(FACILITIES, domain<span class="op">=</span>pyomo.NonNegativeReals)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">## and you can import finished products from WCPO (WCPO--&gt;market1, WCPO---&gt;market2,...)</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    model.canned_imports <span class="op">=</span> pyomo.Var(MARKETS,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>                                     domain<span class="op">=</span>pyomo.NonNegativeReals)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">## one more thing we need is importing loins from WCPO to fill market need for loins</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">## (i.e. loins from WCPO to Spain)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    model.loins_imports_as_final_product <span class="op">=</span> pyomo.Var(MARKETS,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                                                     domain<span class="op">=</span>pyomo.NonNegativeReals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="constraints" class="level3">
<h3 class="anchored" data-anchor-id="constraints">Constraints</h3>
<p>Now we need to define the constraints of the optimization.<br>
Constraints in linear programming are used to do multiple things. They can be used to define reality constraints (you can’t sell more than you have), capacity constraints (you can’t process more than what the cannery can take), productivity (each kg of raw tuna becomes <span class="math inline">\(x\)</span> kg of loins) and a few other things.</p>
<p>First, make sure you limit amount sold downstream to what is landed that year:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">## limit landings per port</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## i.e. the amount moved to processors cannot be higher than what is landed</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> total_landing_limit(model, port):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>(model.port_to_processors[port, processor] <span class="cf">for</span> processor <span class="kw">in</span> FACILITIES) <span class="op">&lt;=</span> total_landings_per_port[port]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    model.total_landings_constraints <span class="op">=</span> pyomo.Constraint(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        PORTS,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span>total_landing_limit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Processors and canneries have a max yearly capacity (given by data) above which it is impossible to produce more.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">## facilities have a capacity.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## I assume the capacity is "processing capacity" that is, the ability to crank out that many finished products</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">## because we split the process in two (loining and canning) I think the right constraint here is:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">## max(loins_produced,tunacans_produced) &lt;= MAX_CAPACITY</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">## this translates into two separate constraints</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">## loins_produced &lt;= MAX_CAPACITY</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## tunacans_produced &lt;= MAX_CAPACITY</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    model.produced_loins <span class="op">=</span> pyomo.Expression(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span>  model, producer:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">sum</span>(model.processor_to_cannery[producer,destination] <span class="cf">for</span> destination <span class="kw">in</span> FACILITIES) <span class="op">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">sum</span>(model.processors_to_export[producer,market] <span class="cf">for</span> market <span class="kw">in</span> MARKETS)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    model.produced_tunacans <span class="op">=</span> pyomo.Expression(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span>  model, producer:</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">sum</span>(model.canneries_to_market[producer,destination] <span class="cf">for</span> destination <span class="kw">in</span> MARKETS)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">## both are limited by max capacity</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    model.processor_maximum_capacity <span class="op">=</span> pyomo.Constraint(</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span><span class="kw">lambda</span> model,facility: model.produced_loins[facility] <span class="op">&lt;=</span> cannery_max_output_capacity[facility]</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    model.canning_maximum_capacity <span class="op">=</span> pyomo.Constraint(</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span><span class="kw">lambda</span> model,facility: model.produced_tunacans[facility] <span class="op">&lt;=</span> cannery_max_output_capacity[facility]</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we define the actual process of loining and canning (as a transformation of inputs into outputs):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>   <span class="co">## model production of loins. Which is just recovered raw material:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## INPUTS * RECOVERY_RATE &gt;= OUTPUT</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    model.input_raw <span class="op">=</span> pyomo.Expression(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span> model, producer:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">sum</span>(model.port_to_processors[port,producer] <span class="cf">for</span> port <span class="kw">in</span> PORTS)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    model.production_loins <span class="op">=</span> pyomo.Constraint(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span>  model, producer:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        model.input_raw[producer]<span class="op">*</span>cannery_transformation_ability[producer] <span class="op">&gt;=</span> model.produced_loins[producer]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">## next we need to model production of cans</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">## I don't know if there even is a recovery rate for this, so it's going to be just one-to-one</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">## INPUTS + LOIN_IMPORTS &lt;= OUTPUT</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    model.input_loins_without_imports <span class="op">=</span> pyomo.Expression(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span> model, canner:</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">sum</span>(model.processor_to_cannery[processor,canner] <span class="cf">for</span> processor <span class="kw">in</span> FACILITIES)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    model.input_loins_total <span class="op">=</span> pyomo.Expression(</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span> model, canner:</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        model.input_loins_without_imports[canner] <span class="op">+</span> model.loins_imports_as_intermediate_product[canner]</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    model.production_tunacans <span class="op">=</span> pyomo.Constraint(</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>        FACILITIES,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span><span class="kw">lambda</span> model,canner:</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        model.input_loins_total[canner] <span class="op">&gt;=</span> model.produced_tunacans[canner]</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice that there is a lot of data on recovery rates but less so on what is the conversion of kg of processed tuna to kg of canned tuna. I had set it 1 to 1 for this, but the more accurate assumption would be that 150g of raw meat are present in 200g of canned tuna (so conversion rate of 1.3333).</p>
<p>Finally as constraints we add that all the international markets receive all the canned and loined tunas they need to consume</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">## demands are fulfilled perfectly</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## total cans</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    model.demand_tunacans_filled <span class="op">=</span> pyomo.Constraint(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        market_list,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span> model,market: <span class="bu">sum</span>(model.canneries_to_market[cannery,market] <span class="cf">for</span> cannery <span class="kw">in</span> FACILITIES) <span class="op">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                                   model.canned_imports[market] <span class="op">==</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>                                   tunacans_total_demand[market])</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">## loins:</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    model.demand_loins_filled <span class="op">=</span> pyomo.Constraint(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        market_list,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span> <span class="kw">lambda</span> model,market: <span class="bu">sum</span>(model.processors_to_export[producer,market] <span class="cf">for</span> producer <span class="kw">in</span> FACILITIES) <span class="op">+</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>                                   model.loins_imports_as_final_product[market] <span class="op">==</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                                   loins_export_demand[market])</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="costs-and-objectives" class="level3">
<h3 class="anchored" data-anchor-id="costs-and-objectives">Costs and objectives</h3>
<p>Now that we have a definition of each variable we can change (flows) and their constraints, we need to define costs and profits in order to choose the variables that maximize them.</p>
<p>You start by setting the transportation costs (which are associated with the flow variables defined above). Notice here that transportation includes the tariff costs (which are very important). One chicken-egg situation is that tariffs are not a fixed $ amount in reality but a % of the total sale value (which we don’t have because we don’t have demand curves).<br>
This we “solve” by using 2017 real prices from WTO data to transform tariffs from % to $.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a> model.costs_transportation_port_to_processor <span class="op">=</span> pyomo.Expression(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(transportation_costs[port][processor] <span class="op">*</span> model.port_to_processors[port, processor] <span class="cf">for</span> port <span class="kw">in</span> PORTS)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> processor <span class="kw">in</span> FACILITIES</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## processor to cannery transportation costs</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    model.costs_transportation_processor_to_cannery <span class="op">=</span> pyomo.Expression(</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                transportation_costs[cleaner][canner] <span class="op">*</span> model.processor_to_cannery[cleaner, canner]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> cleaner <span class="kw">in</span> FACILITIES)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> canner <span class="kw">in</span> FACILITIES</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">## processor to final market transportation costs (loins to sink)</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    model.costs_transportation_loins_export <span class="op">=</span> pyomo.Expression(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span><span class="bu">sum</span>(</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                transportation_costs[cleaner][receiver] <span class="op">*</span> model.processors_to_export[cleaner, receiver]</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> cleaner <span class="kw">in</span> FACILITIES)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> receiver <span class="kw">in</span> MARKETS</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">## canner to market</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    model.costs_transportation_cannery_to_market <span class="op">=</span> pyomo.Expression(</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span><span class="bu">sum</span>(</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>                transportation_costs[canner][market] <span class="op">*</span> model.canneries_to_market[canner, market]</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> canner <span class="kw">in</span> FACILITIES)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> market <span class="kw">in</span> MARKETS</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You also need to pay for the canning and processing (in $ wages):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>  <span class="co">## canner to market</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    model.costs_transportation_cannery_to_market <span class="op">=</span> pyomo.Expression(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span><span class="bu">sum</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>            <span class="bu">sum</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                transportation_costs[canner][market] <span class="op">*</span> model.canneries_to_market[canner, market]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> canner <span class="kw">in</span> FACILITIES)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> market <span class="kw">in</span> MARKETS</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">## costs of loining</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    model.cost_production_loins <span class="op">=</span> pyomo.Expression(</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>( loining_costs[facility] <span class="op">*</span> model.produced_loins[facility] <span class="cf">for</span> facility <span class="kw">in</span> FACILITIES)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">## costs of processing</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    model.cost_production_tunacans <span class="op">=</span> pyomo.Expression(</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>( canning_costs[facility] <span class="op">*</span> model.produced_tunacans[facility] <span class="cf">for</span> facility <span class="kw">in</span> FACILITIES)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The imports and transportations from the WCPO are accounted separately because they involve buying the product as well as transporting it:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">## costs of loining</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    model.cost_production_loins <span class="op">=</span> pyomo.Expression(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>( loining_costs[facility] <span class="op">*</span> model.produced_loins[facility] <span class="cf">for</span> facility <span class="kw">in</span> FACILITIES)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">## costs of processing</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    model.cost_production_tunacans <span class="op">=</span> pyomo.Expression(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>( canning_costs[facility] <span class="op">*</span> model.produced_tunacans[facility] <span class="cf">for</span> facility <span class="kw">in</span> FACILITIES)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">## transportation + acquisition of loins from WCPO</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    model.cost_import_loins_as_intermediate_product <span class="op">=</span> pyomo.Expression(</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            model.loins_imports_as_intermediate_product[facility] <span class="op">*</span> (WCPO_loin_cost <span class="op">+</span> transportation_costs[WCPO_PORT_NAME][facility])</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> facility <span class="kw">in</span> FACILITIES</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    model.cost_import_loins_as_final_product <span class="op">=</span> pyomo.Expression(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            model.loins_imports_as_final_product[market] <span class="op">*</span> (WCPO_loin_cost <span class="op">+</span> transportation_costs[WCPO_PORT_NAME][market])</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> market <span class="kw">in</span> MARKETS</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">## transportation + acquisition of canned from WCPO</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    model.cost_import_canned <span class="op">=</span> pyomo.Expression(</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        expr<span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>            model.canned_imports[market] <span class="op">*</span> (WCPO_tuna_cost <span class="op">+</span> transportation_costs[WCPO_PORT_NAME][market])</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> market <span class="kw">in</span> MARKETS</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>finally you define the problem as one of minimizing all costs subject to constraints and we are done.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">### minimize total costs</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    model.objective <span class="op">=</span> pyomo.Objective(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>        rule<span class="op">=</span><span class="kw">lambda</span> model:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># TRANSPORTATION COSTS</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">## port to processor</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        model.costs_transportation_port_to_processor <span class="op">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">## processor to canner</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        model.costs_transportation_processor_to_cannery <span class="op">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">## processor to direct market (sink)</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        model.costs_transportation_loins_export <span class="op">+</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">## canner to market</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        model.costs_transportation_cannery_to_market <span class="op">+</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># PROCESSING COSTS</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        model.cost_production_loins <span class="op">+</span> model.cost_production_tunacans <span class="op">+</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># IMPORT COSTS (transport and buying)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">###</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        model.cost_import_loins_as_intermediate_product <span class="op">+</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        model.cost_import_loins_as_final_product <span class="op">+</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        model.cost_import_canned</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        ,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        sense<span class="op">=</span>pyomo.minimize</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   _____       _</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  /  ___|     | |</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  \ `--.  ___ | |_   _____</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   `--. \/ _ \| \ \ / / _ \</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  /\__/ / (_) | |\ V /  __/</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#  \____/ \___/|_| \_/ \___|</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">##ask for dual values at all times</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    model.dual <span class="op">=</span> pyomo.Suffix(direction<span class="op">=</span>pyomo.Suffix.IMPORT)</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    solver <span class="op">=</span> pyomo.SolverFactory(<span class="st">'glpk'</span>)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    solver.solve(model)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The code itself includes also a bunch of additional commands to do experiments and sensitivity analysis over it. Will share in its own repository.</p>
</section>
</section>
<section id="data-gathered" class="level2">
<h2 class="anchored" data-anchor-id="data-gathered">Data Gathered</h2>
<p>Basically the model requires the following:</p>
<ol type="1">
<li>Landings (generated from POSEIDON)</li>
<li>Conversion rates (blue book + EUMOFA Conversion factors)</li>
<li>Transportation costs (using UNCTAD data or CIF-FOB from Dale’s dataset)</li>
<li>Tariff rates (WTO data via TAO data analysis)</li>
<li>Production costs (blue book)</li>
<li>Final demands (BACI for imports, local consumption is just a guess what is not exported)</li>
</ol>
<p>The model generates the tuna flows itself but we want to see the real ones in the data so we can compare and validate the model. An analysis of the data is available <a href="https://carrknight.github.io/poseidon/tuna_data_slice2.html">here</a></p>
<p>In general, most of the data is in the tuna supply chain repository. Here I wanted to just give a brief description of what is available.</p>
<p>Trade flows come from <a href="http://www.cepii.fr/CEPII/en/bdd_modele/bdd_modele_item.asp?id=37">BACI</a> which is an harmonization of the UN trade data. This is needed, especially for countries like Ecuador, the official data in the UN is just quite awful.</p>
<p>What makes trade flows in raw catch difficult to analyze however is that due to UN rules, the boat nationality (not the port of landings!) determine the origin of the flow. In other word, if a Spanish boat lands fish in Manta it will appear as exports from Spain to Ecuador, even though in our model this would be simply fish that is available in Manta.</p>
<p>The other problem is with tariffs. First, you must understand that trade data categorizes goods by HACI codes, representing broad categories of products. The ones that matter to us here are:</p>
<pre><code>    "160414"="Fish preparation",
    "030194"="Live Bluefin",
    "030195"="Live Bluefin (south)",
    "030231"="Fresh Albacore",
    "030232"="Fresh Yellowfin",
    "030233"="Fresh Skipjack",
    "030234"="Fresh Bigeye",
    "030235"="Fresh Bigeye (atlantic)",
    "030236"="Fresh Bigeye (southern)",
    "030299"="Fresh offals",
    "030341"="Frozen Albacore",
    "030342"="Frozen Yellowfin",
    "030343"="Frozen Skipjack",
    "030344"="Frozen Bigeye",
    "030345"="Frozen Bigeye (atlantic)",
    "030346"="Frozen Bigeye (southern)",
    "030399"="Frozen offals",
    "030487"="Frozen fillets"</code></pre>
<p>The main problem is that all the 030X stuff represents “raw” fish (just caught), while both the loins and the cans (which in the supply chain model and in reality represent very different things) are all part of the 160414 category.</p>
<p>Because a country may want to tax things differently (Europe taxes loins less than cans, for example) then it needs to add additional codes to represent items. But every country does it differently. So for example,the EU ends up splitting the code <code>160414</code> in the following:</p>
<table class="table">
<colgroup>
<col style="width: 5%">
<col style="width: 94%">
</colgroup>
<thead>
<tr class="header">
<th>16041421</th>
<th>Prepared or preserved skipjack, whole or in pieces, in vegetable oil (excl. minced)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>16041426</td>
<td>Fillets known as “loins” of skipjack, prepared or preserved, whole or in pieces (excl. such products in vegetable oil or minced)</td>
</tr>
<tr class="even">
<td>16041428</td>
<td>Prepared or preserved skipjack, whole or in pieces (excl. minced, fillets known as “loins” and such products in vegetable oil)</td>
</tr>
<tr class="odd">
<td>16041431</td>
<td>Prepared or preserved Yellowfin tuna “Thunnus albacares”, whole or in pieces, in vegetable oil (excl. minced)</td>
</tr>
<tr class="even">
<td>16041436</td>
<td>Fillets known as “loins” of Yellowfin tuna “Thunnus albacares”, prepared or preserved, whole or in pieces (excl. such products in vegetable oil or minced)</td>
</tr>
<tr class="odd">
<td>16041438</td>
<td>Prepared or preserved Yellowfin tuna “Thunnus albacares”, whole or in pieces (excl. minced, fillets known as “loins” and such products in vegetable oil)</td>
</tr>
<tr class="even">
<td>16041441</td>
<td>Prepared or preserved tunas, whole or in pieces, in vegetable oil (excl. minced, skipjack and Yellowfin tuna “Thunnus albacares”)</td>
</tr>
<tr class="odd">
<td>16041446</td>
<td>Fillets known as “loins” of tuna, prepared or preserved, whole or in pieces (excl. such products in vegetable oil or minced, skipjack and Yellowfin tuna “Thunnus albacares”)</td>
</tr>
<tr class="even">
<td>16041448</td>
<td>Prepared or preserved tuna, whole or in pieces (excl. minced, fillets known as “loins” and such products in vegetable oil, skipjack and Yellowfin tuna “Thunnus albacares”)</td>
</tr>
<tr class="odd">
<td>16041490</td>
<td>Prepared or preserved bonito “sarda spp.”, whole or in pieces (excl. minced)</td>
</tr>
</tbody>
</table>
<p>So then one needs to go carefully and decide what is a “loin” and what is a final product. The good thing though is that the WTO data-set also contains quantity and prices traded, not just tariffs, so that in theory this could be used to augment trade data by separating loins from cans.</p>
<p>Transportation cost (in the <code>datagather</code> folder) is something from UNCTAD that we used for the prototype (“slice 1” in the repository) but it is not a very good data-set and the numbers oscillate wildly. There may be a better data set (or a clever way to extract this information from BACI).</p>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<p>My idea is that, with 30 days of work one could accomplish two things:</p>
<ol type="1">
<li>Clean up the data collected and plug them back in the original prototype</li>
<li>Convert the program from pyomo to google or and use in POSEIDON</li>
</ol>
<p>It would take longer to switch to monthly time steps (especially if we want to deal with inventories) but not impossible (the blue book has that data available).</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>